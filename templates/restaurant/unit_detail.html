{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ object.name }}{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        $(function() {
            $("#shopping-cart").load("{% url order:shopping-cart object.id %}");

            $("#last-orders").load("{% url order:list_unit object.id %}", function() {
                pageLinks();
            });
            $("#show-previous-link").click(function(e) {
                $("#last-orders").slideToggle();
                e.preventDefault();
            })
            $("#toggle-info").click(function(e) {
                $("#establishment_details").slideToggle();
                e.preventDefault();
            });
            $(".shop-link").click(function(e) {
                var id = $(this).attr("itemid");
                shop(id);
                $(this).parents("li.item:first").next(".top-span").fadeIn();
                e.preventDefault();
            });
            $(".shop-top-link").click(function(e) {
                var id = $(this).attr("itemid") + "_" + $(this).attr("topid");
                shop(id);
                e.preventDefault();
            });
        });

        function shop(id) {
            var selCart = $("a.selected-cart");
            var parentUL = selCart.next("ul");
            var menuItem = parentUL.children("li[itemid='" + id + "']");
            if (menuItem.length > 0) {
                $("a.incr-link", menuItem).click();
            } else {
                $.get("/order/shop/" + selCart.text() + "/" + id + "/", function(data) {
                    parentUL.append(itemTemplate(data['id'], data['price'], data['name']));
                    parentUL.next("div.subtotal-div").children("span.cart-subtotal:first").text(data['subtotal']);
                    $("#order-total").text(data['total']);
                    showHideMinOrder();
                });
            }
        }

        function itemTemplate(id, price, title) {
            return '<li itemid="' + id + '" class="cart-item">\
          <span class="item-count">1</span>\
          <span class="item-price">' + price + '</span>\
          <span class="item-title">x ' + title + '</span>\
          <a href="#" class="decr-link"></a>\
          <a href="#" class="incr-link"></a>\
          <span class="item-currency">{% trans "RON" %}</span>\
          <span class="item-total">' + price + '</span>\
          </li>';
        }

        function pageLinks() {
            $(".page, .next, .prev").click(function(e) {
                $.get("{% url order:list_unit object.id %}" + $(this).attr("href"), function(data) {
                    $("#last-orders").html(data);
                    pageLinks();
                });
                e.preventDefault();
            });
        }
    </script>
{% endblock %}

{% block content %}

    <div class="content_area">
        <div id="paginarestaurant">
            <div class="title"><h1>{{ object.name|upper }} {% trans 'details'|upper %}</h1></div>
            <a id="toggle-info" href="#">{% trans 'More info' %}</a>
            <div id="establishment_details">
                <strong>{% trans 'Address' %}:</strong> {{ object.address }}<br/>
                <strong>{% trans 'Email' %}:</strong> <a href="mailto:{{ object.email }}">{{ object.email }}</a><br/>
                <strong>{% trans 'Phone' %}:</strong> {{ object.phone }}<br/>
                <strong>{% trans 'Open hours' %}:</strong> {{ object.schedule }}, {% trans 'Open' %}: {{ object.schedule.is_open|yesno }}
                <br/>
                {% if object.info %}<strong>{% trans 'Info' %}:</strong> {{ object.info|safe }}<br/>{% endif %}
            </div>
            {% if object.logo_path %}
                <div id="establishment_picture">
                    <img height="100" src="{{ MEDIA_URL }}{{ object.logo_path }}" alt="logo"/>
                </div>
            {% endif %}
            {% if motd %}
                <div class="clear"></div>
                <div class="content_area">
                    <div class="title"><h3>{% trans 'Menu of the day' %}</h3></div>
                    <h4><a class="shop-link" itemid="{{ motd.get_id }}" href="#">{{ motd.name }}</a></h4>
                    {{ motd.description|safe }}
                </div><!-- content_area -->
            {% endif %}
            <div class="clear"></div>
            <a id="show-previous-link" href="#">{% trans 'Previous orders at this restaurant' %}</a>

            <div class="clear"></div>
            <div id="last-orders" style="display:none"></div>
            <div class="clear"></div>

            <div class="title"><h1>{% trans 'Menu list'|upper %}</h1></div>
            <div class="establishment-menu">
                {% for itemgroup in object.itemgroup_set.iterator %}
                    {% if itemgroup.active %}
                        <h2>{{ itemgroup.name_def }}</h2>
                        <ul>
                            {% for item in itemgroup.item_set.iterator %}
                                {% if item.active %}
                                    <li class="item {% if item.is_new %}new-item{% endif %} pozrel">
                                        <div class="name">{{ item.name_def }}</div>
                                        <br/>

                                        <div class="description">{{ item.description_def }}</div>
                                        <div class="price">
                                            {{ item.get_price }} {% trans 'RON' %}
                                            <a href="#" itemid="{{ item.id }}" title=""
                                               class="button shop-link">{% trans 'Add to order' %}</a>
                                        </div>
                                        <div class="clear"></div>
                                    </li>
                                    {% if item.toppings %}
                                        <div id="top{{ item.id }}" class="top-span" style="display:none">
                                            <span class="topping-span">
                                                <ul>
                                                    {% for top in item.toppings.topping_set.iterator %}
                                                        <li>
                                                            <div class="name">{{ top.name_def }}</div>
                                                            <br/>

                                                            <div class="description">{{ top.description_def }}</div>
                                                            <div class="price">
                                                                {{ top.get_price }} {% trans 'RON' %}
                                                                <a itemid="{{ item.id }}" topid="{{ top.id }}" href="#"
                                                                   class="button shop-top-link">{% trans 'Add to order' %}</a>
                                                            </div>
                                                            <div class="clear"></div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </span>
                                        </div> <!-- top-span -->
                                    {% endif %}
                                    <div class="clear"></div>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% endif %}
                    {% cycle '' '' '<div class="clear"></div>' %}
                {% endfor %}
                {% if forloop.counter < 3 %}
                    <div class="clear"></div>
                {% endif %}
            </div> <!-- estabilshment-menu -->
            <br/><br/>
        </div><!-- paginarestaurant -->
    </div><!-- content_area -->

{% endblock %}

