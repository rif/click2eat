{% load i18n l10n %}


<div id="carts">
{% for cn, cart, subtotal in carts %}
  <a href="#" class="{% if cn == user.username %}selected-cart{% endif %} cart-name">{{ cn }}</a>
<ul class="items">
{% for item, values in cart.iteritems %}
  <li class="cart-item" itemid="{{ item }}">
    <span class="item-count">{{ values.0 }}</span>
    <span class="item-price">{{ values.1|unlocalize }}</span>
    <span class="item-title">x {{ values.2 }}</span>
    <a class="decr-link" href="#"></a>
    <a class="incr-link" href="#"></a>
    <span class="item-currency">{% trans 'RON' %}</span>
    <span class="item-total"></span>
  </li>
  {% endfor %}
</ul>
<div class="subtotal-div">
  {% trans 'Subtotal' %}: <span class="cart-subtotal">{{ subtotal|unlocalize }}</span>{% trans 'RON' %}
</div>
{% endfor %}
</div>
<div class="nota">
  <div id="new-cart-placeholder"></div>
  <a href="{% url order:add-cart %}" id="add-cart">{% trans 'Add shopping cart' %}</a><br/>
  _________________________
  <br/>
  <div class="textnota">NOTA DE PLATÄ‚:</div>&nbsp;
  <span id="min-span">({% trans 'Minimum order: ' %}<span id="min-order">{{ unit.minimum_ord_val }}</span>{% trans 'RON' %}.)</span>
  <div class="totalnota"><span id="order-total">{{ total_sum|unlocalize }}</span> Lei</div>
  <a class="button" title="" href="/order/send/4/">
    <span class="textbtn">CONFIRMA COMANDA</span>
  </a>
</div>

<script type="text/javascript">
function showHideMinOrder(){
    var ct = parseFloat($("#order-total").text());
    var mo = parseFloat($("#min-order").text());
    if (ct > mo) {
      $("#min-span").hide();
    } else {
      $("#min-span").show();
    }
}
function calculateOrderTotal(){
  var total = 0;
  $("span.cart-subtotal").each(function(){
    total += parseFloat($(this).text());
  });
  $("#order-total").text(total.toFixed(2));
  showHideMinOrder();
}
$(function(){
  calculateOrderTotal();
  $("#confirm").click(function(e){
    var send_error = false;
    if ($("#unit-closed").length > 0){
      alert("{% trans 'The restaurant is now closed' %}!");
      send_error = true;
    }
    if (! send_error && $("#min-span:visible").length > 0){
      alert("{% trans 'Minimum order for this unit is:' %} {{ unit.minimum_ord_val }}{% trans 'RON' %}");
      send_error = true;
    }
    if (! send_error)  {
      $.get($(this).attr("href"),{'dt':$("#dt input:checked").val(), 'da':$("#da input:checked").val()}, function(){
        alert("{% trans 'Your order has been sent to the restaurant!' %}");
      });
      $.mobile.changePage("{% url mobile:home %}");
    }
    e.preventDefault();
  });
  $(".items>li").each(function(){
    var parent = $(this);
    var count = parseInt($("span.item-count", parent).text());
    var price = parseFloat($("span.item-price", parent).text());
    $("span.item-total", parent).text(count*price);
  });

  $("#add-cart").click(function(e) {
    if ($("#id_name").length == 0) { // we don't have one already
        $("#new-cart-placeholder").html('<form action="" method="post" id="cart-name-form">\
            <label for="id_name">Name:</label>\
            <input type="text" maxlength="10" name="name" id="id_name"><br/>\
            <button class="button" type="submit">{% trans "Submit" %}</button>\
            <a href="#" class="button" id="new-cart-cancel">{% trans "Cancel" %}</a>\
            </form>');
    }
    $("#id_name").focus();
    $("#new-cart-cancel").click(function(e){
        $("#cart-name-form").remove();
        e.preventDefault();
    });
    $("#cart-name-form").submit(function(){
      var newCart = $("#id_name").val().replace(/ <>&/g, '-');
      if($('#carts>#'+newCart).length == 0){
        $("#carts").append('<a id="'+ newCart +'" class="cart-name" href="#">' + newCart + '</a><ul class="items"></ul>');
        cartSelectionBinding();
        $('#carts>#'+newCart).click();
      }
      $("#cart-name-form").remove();
      return false;
    });
    e.preventDefault();
  });
  cartSelectionBinding();
   incrDecrBinding();
});

function cartSelectionBinding() {
  $(".cart-name").unbind("click");
  $(".cart-name").click(function(e){
        $(".cart-name").removeClass("selected-cart");
        $(this).addClass("selected-cart");
        e.preventDefault();
  });
}

function incrDecrBinding(){
   $(".decr-link, .incr-link").unbind("click");
   $(".decr-link, .incr-link").click(function(e){
    var isMinus = $(this).hasClass("decr-link");
    var parent = $(this).parents("li:first");
    var iid = parent.attr("itemid");
    var parentUL = parent.parent("ul.items");
    var parentCart = parentUL.prev("a.cart-name:first");
    parentCart.click(); // select cart
    if (isMinus){
      var href = "/order/decritem/" + parentCart.text() + "/{{ unit.id }}/" + iid + "/";
    } else {
      var href = "/order/incritem/" + parentCart.text() + "/{{ unit.id }}/" + iid + "/";
    }
    $.get(href, function(data){
       parentUL.next("div.subtotal-div").children("span.cart-subtotal:first").text(data['count']);
       var count = $("span.item-count", parent);
       var price = $("span.item-price", parent);
       var total = $("span.item-total", parent);
       if(isMinus) {
        if(parseInt(count.text()) > 1){
          count.text(parseInt(count.text()) - 1);
        } else {
          parent.fadeOut("slow").remove();
          $("#items>li[itemid^="+iid+"]").fadeOut();
        }
       } else {
        count.text(parseInt(count.text()) + 1);
       }
       total.text(parseInt(count.text())*parseFloat(price.text()).toFixed(2));
       calculateOrderTotal();
    });
    e.preventDefault();
  });
}
</script>
